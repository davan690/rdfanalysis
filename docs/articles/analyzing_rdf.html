<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analyzing Researcher Degrees of Freedom:<br>
A Case Study • rdfanalysis</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Analyzing Researcher Degrees of Freedom:&lt;br /&gt;
A Case Study">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-119053376-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-119053376-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rdfanalysis</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/analyzing_rdf.html">Analyzing Researcher Degrees of Freedom:  
A Case Study</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://www.github.com/joachim-gassen/rdfanalysis">
    <span class="fa fa-github"></span>
     
    Code repository
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><script src="analyzing_rdf_files/htmlwidgets-1.3/htmlwidgets.js"></script><script src="analyzing_rdf_files/viz-1.8.2/viz.js"></script><link href="analyzing_rdf_files/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="analyzing_rdf_files/grViz-binding-1.0.0/grViz.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Analyzing Researcher Degrees of Freedom:<br>
A Case Study</h1>
                        <h4 class="author">Joachim Gassen</h4>
            
            <h4 class="date">2019-05-03</h4>
      
      
      <div class="hidden name"><code>analyzing_rdf.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>The idea of the in-development <code>rdfanalysis</code> package is to provide a coding environment that allows researchers to systematically document and analyze the degrees of freedom in their research designs. The notion “researcher degrees of freedom” has been introduced by <a href="https://journals.sagepub.com/doi/pdf/10.1177/0956797611417632">Simmons et al., (Psyc Science, 2011)</a>. In their own words (p. 1359):</p>
<blockquote>
<p>The culprit is a construct we refer to as <em>researcher degrees of freedom</em>. In the course of collecting and analyzing data, researchers have many decisions to make: Should more data be collected? Should some observations be excluded? Which conditions should be combined and which ones compared? Which control variables should be considered? Should specific measures be combined or transformed or both?</p>
</blockquote>
<p>This vignette will use a case to guide you through the process of how to use the package for an analysis that makes its inherent researcher degrees of freedom transparent. The outcome of this activity will be similar to the multiverse analysis approach suggested by <a href="https://journals.sagepub.com/doi/abs/10.1177/1745691616658637">Steeger et al. (Persp on Psych Sci 2016)</a>.</p>
</div>
<div id="the-case" class="section level2">
<h2 class="hasAnchor">
<a href="#the-case" class="anchor"></a>The Case</h2>
<p>As case we assess the impact of real Gross Domestic Product (GDP) per capita on life expectancy. This association has become known as the <a href="https://en.wikipedia.org/wiki/Preston_curve">Preston Curve</a> (<a href="https://www.tandfonline.com/doi/abs/10.1080/00324728.1975.10410201">Preston, Pop Studies, 1975</a>).</p>
<center>
<div class="figure">
<img src="preston_1975_p235.png" alt="Preston (1975): The Changing Relation between Mortality and level of Economic Development, Population Studies (29): 235." width="672"><p class="caption">Preston (1975): The Changing Relation between Mortality and level of Economic Development, Population Studies (29): 235.</p>
</div>
</center>
<p>We will estimate the respective coefficient for GDP per capita in a multiple regression framework on a panel data set of country-year data provided by the <a href="https://data.worldbank.org">World Bank</a> (GDP per capita, life expectancy at birth and unemployment rates), and the <a href="http://dataexplorer.wittgensteincentre.org/wcde-v2/">Wittgenstein Center</a> for mean years of schooling received by country inhabitants being 15 years or older. As the schooling data is available at 5 year intervals only, I interpolate the years in-between linearly to keep the data at annual frequency (another research degree of freedom, I know …). If you want to explore the data underlying the case, <a href="https://jgassen.shinyapps.io/expand_rdfanalysis">click here</a> to access an interactive data exploration tool based on my <a href="https://joachim-gassen.github.io/ExPanDaR">ExPanDaR package</a>. With this tool, you can also re-generate most protocols that we study below by hand.</p>
<p>While the analysis it not meant to contribute to the question whether there is a causal link between GDP per capita and life expectancy (see <a href="https://doi.org/10.1111/padr.12141">Lutz and Kebede, Pop and Dev Review 2018</a> for a recent discussion), I design the analysis such that identifying assumptions for such a causal interpretation of its findings are explicit.</p>
</div>
<div id="step-1-define-research-design-by-a-series-of-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#step-1-define-research-design-by-a-series-of-functions" class="anchor"></a>Step 1: Define research design by a series of functions</h2>
<p>Every research design can be implemented as a series of functions where each function receives the output of the previous function as a parameter and produces output for the next function.</p>
<p>In the terminology of the <code>rdfanalysis</code> package, each function is called a “design step”. It comes with “choices” that can be either discrete or continuous in nature. The choices are what generate researcher degrees of freedom. A set of made choices across all steps of a design constitutes a “research protocol”. The total number of feasible research protocols equals the researcher degrees of freedom of a research design.</p>
<p>In our case and in most designs, the first step reads or generates data, and the last step generates results. In principle, the <code>rdfanalysis</code> package is agnostic about the data structure that constitutes a result. In most cases, the result will take the form of one or several confidence intervals. In our case, it is the 95 % confidence interval for the effect of a 10 % GDP per capita increase on life expectancy in years, provided by three variables:</p>
<ul>
<li>the estimate (<code>est</code>)</li>
<li>a lower bound (<code>lb</code>) and</li>
<li>an upper bound (<code>ub</code>).</li>
</ul>
<p>To assess the impact of GDP per capita on life expectancy, our case design follows the following steps</p>
<ul>
<li>Read data</li>
<li>Select independent variables for model</li>
<li>Treat extreme observations</li>
<li>Specify model</li>
<li>Estimate model</li>
</ul>
<p>Each step will be implemented by a function. To set up such a functional structure, you use the command <code><a href="../reference/define_design.html">define_design()</a></code>. This function creates a series of function templates in a directory of your choice. Existing files are not over-written. You can choose whether you want your functions all in one R file or whether you want to generate separate files. I am going with separate files here.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(rdfanalysis)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(readr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ExPanDaR)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(knitr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(testthat)

design &lt;-<span class="st"> </span><span class="kw"><a href="../reference/define_design.html">define_design</a></span>(<span class="dt">steps =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"read_data"</span>, 
                                  <span class="st">"select_idvs"</span>, 
                                  <span class="st">"treat_extreme_obs"</span>, 
                                  <span class="st">"specify_model"</span>, 
                                  <span class="st">"est_model"</span>),
                        <span class="dt">rel_dir =</span> <span class="st">"case_study_code"</span>)</code></pre></div>
</div>
<div id="step-2-implement-design-steps" class="section level2">
<h2 class="hasAnchor">
<a href="#step-2-implement-design-steps" class="anchor"></a>Step 2: Implement design steps</h2>
<p>When you take a look at the newly created directory, you will see a set of R files. Each file contains a template like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">step_name &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">input =</span> <span class="ot">NULL</span>, <span class="dt">choice =</span> <span class="ot">NULL</span>) {
  <span class="co"># This is a template for a design step</span>
  <span class="co"># to be used by the rdfanalysis package</span>
  <span class="co"># See https://joachim-gassen.github.io/rdfanalysis</span>
  <span class="co"># for further information on how to use this template</span>
  <span class="co"># and the package.</span>

  <span class="co"># Feel free to delete any/all lines containing comments but leave</span>
  <span class="co"># the line containing ("Analysis code starts below") unchanged.</span>

  <span class="co"># Provide your documentation in the two variables below.</span>
  <span class="co"># They will be used by prepare_design_documentation()</span>

  step_description &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
    <span class="st">"## [Step Title]"</span>,
    <span class="st">"### Content"</span>,
    <span class="st">""</span>,
    <span class="st">"[Explain what the step does]"</span>
  )
  choice_description &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
    <span class="st">"### Choice"</span>,
    <span class="st">""</span>,
    <span class="st">"`[name of discrete choice]`: A character value containing one of the"</span>,
    <span class="st">"following values:"</span>,
    <span class="st">""</span>,
    <span class="st">"- `[valid_value 1]`: [What this choice does]"</span>,
    <span class="st">"- `[valid_value n]`: [What that choice does]"</span>,
    <span class="st">""</span>,
    <span class="st">"`[name of continuous choice]`: [Explain valid range for continuous choice"</span>,
    <span class="st">"and what it does]"</span>
  )

  <span class="co"># Specify your valid choices below. Format will be checked by test_design()</span>
  <span class="co"># for consistency</span>

  choice_type &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">name =</span> <span class="st">"[name of discrete choice]"</span>,
         <span class="dt">type =</span> <span class="st">"character"</span>,
         <span class="dt">valid_values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"[valid_value 1]"</span>, <span class="st">"[valid_value n]"</span>),
         <span class="co"># weights are not required but they need to add up to one if</span>
         <span class="co"># they are provided. Adjust the example below</span>
         <span class="dt">weights =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.8</span>, <span class="fl">0.2</span>)),
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">name =</span> <span class="st">"[name of continuous choice]"</span>,
         <span class="dt">type =</span> <span class="st">"double"</span>,
         <span class="dt">valid_min =</span> <span class="dv">0</span>, <span class="dt">valid_max =</span> <span class="fl">0.1</span>,
         <span class="co"># weights for continuous choices are provided by a sample of choices.</span>
         <span class="co"># Could be just one value. Adjust the example below</span>
         <span class="dt">weight_sample =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="fl">0.01</span>, <span class="dv">4</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="fl">0.05</span>, <span class="dv">4</span>)))
  )

  <span class="co"># You should not need to change anything in the following code section</span>

  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NULL">is.null</a></span>(choice)) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">step_description =</span> step_description,
    <span class="dt">choice_description =</span> choice_description,
    <span class="dt">choice_type =</span> choice_type
  )) <span class="cf">else</span> <span class="kw"><a href="../reference/check_choice.html">check_choice</a></span>(choice, choice_type)

  <span class="co"># Leave the following comment untouched. It is being used by</span>
  <span class="co"># prepare_design_documentation() to identify the part of the step</span>
  <span class="co"># that should be included in the documentation.</span>

  <span class="co"># ___ Analysis code starts below ___</span>

  <span class="co"># Here you need to add your code.</span>

  <span class="co"># If this is the first step of your design, you can access input data via the</span>
  <span class="co"># input parameter. If it is a subsequent step, you can access input data</span>
  <span class="co"># via input$data and the protocol leading to this step by input$protocol.</span>

  <span class="co"># Make sure that you address all choices identified above.</span>

  <span class="co"># In the return block below, you need to replace the placeholder with the</span>
  <span class="co"># variable that contains the data that you want to return as output</span>
  <span class="co"># to the next step or as a result if this is the last step.</span>

  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">data =</span> <span class="st">"[variable containing your output data structure here]"</span>,
    <span class="dt">protocol =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(choice)
  ))
}</code></pre></div>
<p>The task is now to implement the code for each step. To do so, you should first set <code>step_description</code> and <code>choice_description</code>. Each variable takes a vector of strings that will be concatenated to R Markdown code to provide the code documentation (see <code><a href="../reference/prepare_design_documentation.html">prepare_design_documentation()</a></code> below). Use these variables to explain what the step does and which choices it contains.</p>
<p>Let’s apply this to our first design step <code>read_data()</code>. When we import the raw data, we can decide whether we require each country-year observation to have non-missing data for all potential variables. To implement this discrete choice, you document it in <code>choice_description</code> and specify it in <code>choice_type</code>. The <code>weight</code> parameter can be used to provide the choice (or weighting of choices) that you <em>a priori</em> assume to be supported by theory. The final function <code>read_data()</code> is provided below. It simply reads a CSV file containing data, limits the sample to the required variables and deletes cases with missing data if the choice <code>na.omit</code> is set to <code>"yes"</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">read_data &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">input =</span> <span class="ot">NULL</span>, <span class="dt">choice =</span> <span class="ot">NULL</span>) {
  step_description &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
    <span class="st">"## Read data"</span>,
    <span class="st">"### Content"</span>,
    <span class="st">""</span>,
    <span class="st">"Reads country year world bank data CSV file and generates raw sample"</span>
  )
  choice_description &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
    <span class="st">"### Choice"</span>,
    <span class="st">""</span>,
    <span class="st">"`na.omit`: A character value containing one of the"</span>,
    <span class="st">"following values:"</span>,
    <span class="st">""</span>,
    <span class="st">"- `yes`: All observations with missing data are excluded"</span>,
    <span class="st">"- `no`: All observations with missing data are included"</span>
  )

  choice_type &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">name =</span> <span class="st">"na.omit"</span>,
         <span class="dt">type =</span> <span class="st">"character"</span>,
         <span class="dt">valid_values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"yes"</span>, <span class="st">"no"</span>),
         <span class="dt">weights =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>, <span class="dv">0</span>))
  )
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NULL">is.null</a></span>(choice)) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">step_description =</span> step_description,
    <span class="dt">choice_description =</span> choice_description,
    <span class="dt">choice_type =</span> choice_type
  )) <span class="cf">else</span> <span class="kw"><a href="../reference/check_choice.html">check_choice</a></span>(choice, choice_type)
  <span class="co"># ___ Analysis code starts below ___</span>

  df &lt;-<span class="st"> </span><span class="kw"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span>(input, <span class="dt">col_types =</span> <span class="kw"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span>()) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"country"</span>, <span class="st">"year"</span>), as.factor) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(country, year,
           lifeexpectancy, gdp_capita,
           mn_yrs_school, unemployment)

  <span class="cf">if</span>(choice <span class="op">==</span><span class="st"> "yes"</span>) df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/na.fail">na.omit</a></span>()

  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">data =</span> df,
    <span class="dt">protocol =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(choice)
  ))
}</code></pre></div>
<p>For the other steps you follow the same approach. For our case study, I implement the following choices:</p>
<ul>
<li>
<code>select_idvs()</code>: selects the independent variables that we want to include in our regression model. <code>idvs</code> names these variables.</li>
<li>
<code>treat_extreme_obs()</code>: treats extreme observations that otherwise tend to be highly influential for regression outcomes. <code>outlier_tment_style</code> indicates whether you want to use truncating or winsorizing. <code>outlier_cutoff</code> holds the percentile cutoff. It can be within the range [0, 0.1] (0 to 10 %, with 0 indicating no outlier treatment).</li>
<li>
<code>specify_model()</code>: provides the specification of the regression model. <code>model_type</code> determines whether the model will be estimated as level-level, log-level, level-log or log-log specification.</li>
<li>
<code>est_model()</code>: estimates the main effect of interest. To make the estimates comparable across the different model specifications the model coefficients are transformed so that each estimates the life expectancy effect in years of a 10 % increase in GDP per capita. The choice <code>feffects</code> determines which fixed effects are used (none, country, year or both) and <code>cluster</code> indicates how the standard errors should be clustered (not, by country, by year, or two-way by country and year).</li>
</ul>
<p>All these choices are rather standard choices in research designs based on observational data. Taken together and assuming that you want to generate outlier cases for each percentile from 0 to 10, they generate <span class="math inline">\(2 * 4 * 2 * 11 * 4 * 4 * 4 = 11,264\)</span> researcher degrees of freedom!</p>
<p>Below you find all four functions. Copy and paste them into the template files to generate your research design.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">select_idvs &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">input =</span> <span class="ot">NULL</span>, <span class="dt">choice =</span> <span class="ot">NULL</span>) {
  step_description &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
    <span class="st">"## Identify the variables for analysis"</span>,
    <span class="st">"### Content"</span>,
    <span class="st">""</span>,
    <span class="st">"Select the variables that you want to use in the regression analysis."</span>
  )
  choice_description &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
    <span class="st">"### Choice"</span>,
    <span class="st">""</span>,
    <span class="st">"`idvs`: A character value containing one of the"</span>,
    <span class="st">"following values:"</span>,
    <span class="st">""</span>,
    <span class="st">"- `gdp_only`: GDP per capita only"</span>,
    <span class="st">"- `gdp_school`: GDP per capita and mean years schooling"</span>,
    <span class="st">"- `gdp_ue`: GDP per capita and unemployment"</span>,
    <span class="st">"- `full`: Full model including all three variables"</span>
  )
  choice_type &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">name =</span> <span class="st">"idvs"</span>,
         <span class="dt">type =</span> <span class="st">"character"</span>,
         <span class="dt">valid_values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"gdp_only"</span>, <span class="st">"gdp_school"</span>, <span class="st">"gdp_ue"</span>, <span class="st">"full"</span>),
         <span class="dt">weights =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>))
  )
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NULL">is.null</a></span>(choice)) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">step_description =</span> step_description,
    <span class="dt">choice_description =</span> choice_description,
    <span class="dt">choice_type =</span> choice_type
  )) <span class="cf">else</span> <span class="kw"><a href="../reference/check_choice.html">check_choice</a></span>(choice, choice_type)
  <span class="co"># ___ Analysis code starts below ___</span>

  df &lt;-<span class="st"> </span><span class="cf">switch</span> (choice[[<span class="dv">1</span>]],
                <span class="st">"gdp_only"</span> =<span class="st"> </span>input<span class="op">$</span>data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>mn_yrs_school, <span class="op">-</span>unemployment),
                <span class="st">"gdp_school"</span> =<span class="st"> </span>input<span class="op">$</span>data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>unemployment),
                <span class="st">"gdp_ue"</span> =<span class="st"> </span>input<span class="op">$</span>data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>mn_yrs_school),
                <span class="st">"full"</span> =<span class="st"> </span>input<span class="op">$</span>data
  )

  protocol &lt;-<span class="st"> </span>input<span class="op">$</span>protocol
  protocol[[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(protocol) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>]] &lt;-<span class="st">  </span>choice
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">data =</span> df,
    <span class="dt">protocol =</span> protocol
  ))
}


treat_extreme_obs &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">input =</span> <span class="ot">NULL</span>, <span class="dt">choice =</span> <span class="ot">NULL</span>) {
  step_description &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
    <span class="st">"## Select the type of outlier treatment"</span>,
    <span class="st">"### Content"</span>,
    <span class="st">""</span>,
    <span class="st">"Select how you want to treat extreme observations. They can be winsorized or truncated"</span>,
    <span class="st">"to a given percentile of the data."</span>
  )
  choice_description &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
    <span class="st">"### Choice"</span>,
    <span class="st">""</span>,
    <span class="st">"A list containing a character value `outlier_tment_style` and a numerical value `outlier_cutoff`."</span>,
    <span class="st">"`outlier_tment_style` may take one of the following values:"</span>,
    <span class="st">""</span>,
    <span class="st">"- `win`: Winsorization"</span>,
    <span class="st">"- `trunc`: Truncation"</span>,
    <span class="st">""</span>,
    <span class="st">"`outlier_cutoff` sets the cut-off percentile for the outlier treatment"</span>,
    <span class="st">"and may take any value within [0, 0.10]"</span>
  )
  choice_type &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">name =</span> <span class="st">"outlier_tment_style"</span>,
         <span class="dt">type =</span> <span class="st">"character"</span>,
         <span class="dt">valid_values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"win"</span>, <span class="st">"trunc"</span>),
         <span class="dt">weights =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>)),
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">name =</span> <span class="st">"outlier_cutoff"</span>,
         <span class="dt">type =</span> <span class="st">"double"</span>,
         <span class="dt">valid_min =</span> <span class="dv">0</span>, <span class="dt">valid_max =</span> <span class="fl">0.1</span>,
         <span class="dt">weight_sample =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="fl">0.01</span>, <span class="dv">4</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="fl">0.05</span>, <span class="dv">4</span>)))
  )
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NULL">is.null</a></span>(choice)) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">step_description =</span> step_description,
    <span class="dt">choice_description =</span> choice_description,
    <span class="dt">choice_type =</span> choice_type
  )) <span class="cf">else</span> <span class="kw"><a href="../reference/check_choice.html">check_choice</a></span>(choice, choice_type)
  <span class="co"># ___ Analysis code starts below ___</span>

  <span class="cf">if</span> (choice[[<span class="dv">2</span>]] <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) {
    protocol &lt;-<span class="st"> </span>input<span class="op">$</span>protocol
    protocol[[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(protocol) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>]] &lt;-<span class="st">  </span>choice
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
      <span class="dt">data =</span> input<span class="op">$</span>data,
      <span class="dt">protocol =</span> protocol
    ))
  }

  <span class="cf">switch</span>(choice[[<span class="dv">1</span>]],
         <span class="st">"win"</span> =<span class="st"> </span>{
           df &lt;-<span class="st"> </span>input<span class="op">$</span>data
           df[, <span class="dv">3</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">ncol</a></span>(df)] &lt;-
<span class="st">             </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ExPanDaR/topics/treat_outliers">treat_outliers</a></span>(df[, <span class="dv">3</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">ncol</a></span>(df)], <span class="dt">percentile =</span> choice[[<span class="dv">2</span>]])
           df
         },
         <span class="st">"trunc"</span> =<span class="st"> </span>{
           df &lt;-<span class="st"> </span>input<span class="op">$</span>data
           df[, <span class="dv">3</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">ncol</a></span>(df)] &lt;-
<span class="st">             </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ExPanDaR/topics/treat_outliers">treat_outliers</a></span>(df[, <span class="dv">3</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">ncol</a></span>(df)],
                            <span class="dt">percentile =</span> choice[[<span class="dv">2</span>]],
                            <span class="dt">truncate =</span> <span class="ot">TRUE</span>)
           df
         })

  protocol &lt;-<span class="st"> </span>input<span class="op">$</span>protocol
  protocol[[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(protocol) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>]] &lt;-<span class="st">  </span>choice
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">data =</span> df,
    <span class="dt">protocol =</span> protocol
  ))
}


specify_model &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">input =</span> <span class="ot">NULL</span>, <span class="dt">choice =</span> <span class="ot">NULL</span>) {
  step_description &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
    <span class="st">"## Specify the model type to be estimated"</span>,
    <span class="st">"### Content"</span>,
    <span class="st">""</span>,
    <span class="st">"Specify whether you want to estimate a level model or whether you"</span>,
    <span class="st">"want to use log tansformed dependent and/or independent variables."</span>
  )
  choice_description &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
    <span class="st">"### Choice"</span>,
    <span class="st">""</span>,
    <span class="st">"`model_type`: A character value containing one of the"</span>,
    <span class="st">"following values:"</span>,
    <span class="st">""</span>,
    <span class="st">"- `level-level`: Use untransformed dependent and independent variables"</span>,
    <span class="st">"- `log-level`: Use log-transformed dependent and"</span>,
    <span class="st">"untransformed independent variables"</span>,
    <span class="st">"- `level-log`: Use untransformed dependent and"</span>,
    <span class="st">"log-transformed independent variables"</span>,
    <span class="st">"- `log-log`: Use log-transformed dependent and independent variables"</span>
  )
  choice_type &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">name =</span> <span class="st">"model_type"</span>,
         <span class="dt">type =</span> <span class="st">"character"</span>,
         <span class="dt">valid_values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"level-level"</span>, <span class="st">"log-level"</span>,
                          <span class="st">"level-log"</span>, <span class="st">"log-log"</span>),
         <span class="dt">weights =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>))
  )
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NULL">is.null</a></span>(choice)) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">step_description =</span> step_description,
    <span class="dt">choice_description =</span> choice_description,
    <span class="dt">choice_type =</span> choice_type
  )) <span class="cf">else</span> <span class="kw"><a href="../reference/check_choice.html">check_choice</a></span>(choice, choice_type)
  <span class="co"># ___ Analysis code starts below ___</span>

  df &lt;-<span class="st"> </span>input<span class="op">$</span>data

  <span class="cf">if</span> (choice <span class="op">==</span><span class="st"> "log-level"</span> <span class="op">|</span><span class="st"> </span>choice <span class="op">==</span><span class="st"> "log-log"</span>)
    df<span class="op">$</span>lifeexpectancy &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(df<span class="op">$</span>lifeexpectancy)
  <span class="cf">if</span> (choice <span class="op">==</span><span class="st"> "level-log"</span> <span class="op">|</span><span class="st"> </span>choice <span class="op">==</span><span class="st"> "log-log"</span>)
    df[,<span class="dv">4</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">ncol</a></span>(df)] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(df[,<span class="dv">4</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">ncol</a></span>(df)])

  protocol &lt;-<span class="st"> </span>input<span class="op">$</span>protocol
  protocol[[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(protocol) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>]] &lt;-<span class="st"> </span>choice

  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">data =</span> df,
    <span class="dt">protocol =</span> protocol
  ))
}


est_model &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">input =</span> <span class="ot">NULL</span>, <span class="dt">choice =</span> <span class="ot">NULL</span>) {
  step_description &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
    <span class="st">"## Estimates the model"</span>,
    <span class="st">"### Content"</span>,
    <span class="st">""</span>,
    <span class="st">"Uses a multiple regression setup to generate an estimate and"</span>,
    <span class="st">"a confidence interval for the effect of a 10 % increase in GDP per capita"</span>,
    <span class="st">"on life expectancy in years."</span>
  )
  choice_description &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
    <span class="st">"### Choice"</span>,
    <span class="st">""</span>,
    <span class="st">"A list containing two character values: `cluster` and `feffect`."</span>,
    <span class="st">"`cluster` defines the clustering of standard errors and"</span>,
    <span class="st">"`feffect` defines the fixed effect structure of the model."</span>,
    <span class="st">"Each value may take one of the following values:"</span>,
    <span class="st">""</span>,
    <span class="st">"- `none`, `ctry`, `year` or `ctryyear`"</span>
  )
  choice_type &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">name =</span> <span class="st">"feffect"</span>,
         <span class="dt">type =</span> <span class="st">"character"</span>,
         <span class="dt">valid_values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"none"</span>, <span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"ctryyear"</span>),
         <span class="dt">weights =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>)),
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">name =</span> <span class="st">"cluster"</span>,
         <span class="dt">type =</span> <span class="st">"character"</span>,
         <span class="dt">valid_values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"none"</span>, <span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"ctryyear"</span>),
         <span class="dt">weights =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>))
  )
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NULL">is.null</a></span>(choice)) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">step_description =</span> step_description,
    <span class="dt">choice_description =</span> choice_description,
    <span class="dt">choice_type =</span> choice_type
  )) <span class="cf">else</span> <span class="kw"><a href="../reference/check_choice.html">check_choice</a></span>(choice, choice_type)

  <span class="co"># ___ Analysis code starts below ___</span>

  f &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"lifeexpectancy ~ "</span>,
              <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(input<span class="op">$</span>data)[<span class="dv">4</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(input<span class="op">$</span>data)], <span class="dt">collapse =</span> <span class="st">" + "</span>))

  <span class="cf">if</span> (choice[[<span class="dv">1</span>]] <span class="op">==</span><span class="st"> "country"</span> <span class="op">||</span><span class="st"> </span>choice[[<span class="dv">1</span>]] <span class="op">==</span><span class="st"> "year"</span>) f &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(f, <span class="st">"| "</span>, choice[[<span class="dv">1</span>]])
  <span class="cf">else</span> <span class="cf">if</span> (choice[[<span class="dv">1</span>]] <span class="op">==</span><span class="st"> "ctryyear"</span>) f &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(f, <span class="st">" | country + year"</span>)

  <span class="cf">if</span> (choice[[<span class="dv">2</span>]] <span class="op">==</span><span class="st"> "none"</span>) form &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/formula">as.formula</a></span>(f)
  <span class="cf">else</span> <span class="cf">if</span> (choice[[<span class="dv">1</span>]] <span class="op">==</span><span class="st"> "none"</span>) f &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(f, <span class="st">" | 0 "</span>)

  <span class="cf">if</span> (choice[[<span class="dv">2</span>]] <span class="op">==</span><span class="st"> "country"</span> <span class="op">||</span><span class="st"> </span>choice[[<span class="dv">2</span>]] <span class="op">==</span><span class="st"> "year"</span>) f &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(f, <span class="st">"| 0 | "</span>, choice[[<span class="dv">2</span>]])
  <span class="cf">else</span> f &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(f, <span class="st">"| 0 | country + year "</span>)

  <span class="cf">if</span> (choice[[<span class="dv">2</span>]] <span class="op">!=</span><span class="st"> "none"</span>) form &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/formula">as.formula</a></span>(f)

  mod &lt;-<span class="st"> </span>lfe<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/lfe/topics/felm">felm</a></span>(form, input<span class="op">$</span>data)
  protocol &lt;-<span class="st"> </span>input<span class="op">$</span>protocol

  <span class="cf">if</span> (protocol[[<span class="dv">4</span>]][[<span class="dv">1</span>]] <span class="op">==</span><span class="st"> "level-level"</span>)
    mult &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(<span class="fl">1.1</span>)<span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(input<span class="op">$</span>data<span class="op">$</span>gdp_capita, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  <span class="cf">else</span> <span class="cf">if</span> (protocol[[<span class="dv">4</span>]][[<span class="dv">1</span>]] <span class="op">==</span><span class="st"> "level-log"</span>)
    mult &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(<span class="fl">1.1</span>)
  <span class="cf">else</span> <span class="cf">if</span> (protocol[[<span class="dv">4</span>]][[<span class="dv">1</span>]] <span class="op">==</span><span class="st"> "log-level"</span>)
    mult &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(<span class="fl">1.1</span>)<span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(input<span class="op">$</span>data<span class="op">$</span>gdp_capita, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">*</span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(input<span class="op">$</span>data<span class="op">$</span>lifeexpectancy), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  <span class="cf">else</span> mult &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(<span class="fl">1.1</span>)<span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(input<span class="op">$</span>data<span class="op">$</span>lifeexpectancy), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  l &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">est =</span> mod<span class="op">$</span>coefficients[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/row.names">row.names</a></span>(mod<span class="op">$</span>coefficients) <span class="op">==</span><span class="st"> 'gdp_capita'</span>] <span class="op">*</span><span class="st"> </span>mult,
    <span class="dt">lb =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/confint">confint</a></span>(mod)[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/row.names">row.names</a></span>(mod<span class="op">$</span>coefficients) <span class="op">==</span><span class="st"> 'gdp_capita'</span>, <span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>mult,
    <span class="dt">ub =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/confint">confint</a></span>(mod)[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/row.names">row.names</a></span>(mod<span class="op">$</span>coefficients) <span class="op">==</span><span class="st"> 'gdp_capita'</span>, <span class="dv">2</span>] <span class="op">*</span><span class="st"> </span>mult
  )

  protocol[[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(protocol) <span class="op">+</span><span class="st"> </span><span class="dv">1</span>]] &lt;-<span class="st">  </span>choice
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
    <span class="dt">data =</span> l,
    <span class="dt">protocol =</span> protocol,
    <span class="dt">model =</span> mod
  ))
}</code></pre></div>
</div>
<div id="step-3-source-test-and-document-design" class="section level2">
<h2 class="hasAnchor">
<a href="#step-3-source-test-and-document-design" class="anchor"></a>Step 3: Source, test and document design</h2>
<p>After implementing the design, you need to source it. In addition, you can test the design code for input parameter consistency at this stage. This test will verify that each step provides a step description, a choice description and the valid choice types to the user when called without input parameter. If weights are provided, the test verifies that the weights add up to one and are within the valid choice range.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/source_design.html">source_design</a></span>(design, <span class="dt">rel_dir =</span> <span class="st">"case_study_code"</span>)
<span class="kw"><a href="../reference/test_design.html">test_design</a></span>(design, <span class="dt">reporter =</span> <span class="st">"minimal"</span>)
<span class="co">#&gt; ...............................................................................................................................................</span></code></pre></div>
<p>The test does not complain. Next, the command <code><a href="../reference/prepare_design_documentation.html">prepare_design_documentation()</a></code> produces a PDF document based on the <code>step_description</code> and <code>choice_description</code> that you provided for each step. By default, it also includes the “pay load” code for each design step.</p>
<p>In addition, the command <code><a href="../reference/prepare_design_flow_chart.html">prepare_design_flow_chart()</a></code> produces a visualization of your design steps and of their choices.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/prepare_design_documentation.html">prepare_design_documentation</a></span>(design, <span class="st">"preston_curve_design.pdf"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/prepare_design_flow_chart.html">prepare_design_flow_chart</a></span>(design)</code></pre></div>
<div id="htmlwidget-a8b475b8ef4176f0fa1e" style="width:768px;height:1152px;" class="grViz html-widget"></div>
<script type="application/json" data-for="htmlwidget-a8b475b8ef4176f0fa1e">{"x":{"diagram":"digraph {\n\ngraph [layout = \"dot\",\n       outputorder = \"edgesfirst\",\n       bgcolor = \"white\"]\n\nnode [fontname = \"Helvetica\",\n      fontsize = \"10\",\n      shape = \"circle\",\n      fixedsize = \"true\",\n      width = \"0.5\",\n      style = \"filled\",\n      fillcolor = \"aliceblue\",\n      color = \"gray70\",\n      fontcolor = \"white\"]\n\nedge [fontname = \"Helvetica\",\n     fontsize = \"8\",\n     len = \"1.5\",\n     color = \"gray80\",\n     arrowsize = \"0.5\"]\n\n  \"1\" [label = \"read_data\", shape = \"rectangle\", fixedsize = \"FALSE\", fillcolor = \"#7EC0EE\", fontcolor = \"#FFFFFF\"] \n  \"2\" [label = \"na.omit:\nyes\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"3\" [label = \"na.omit:\nno\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"4\" [label = \"select_idvs\", shape = \"rectangle\", fixedsize = \"FALSE\", fillcolor = \"#7EC0EE\", fontcolor = \"#FFFFFF\"] \n  \"5\" [label = \"idvs:\ngdp_only\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"6\" [label = \"idvs:\ngdp_school\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"7\" [label = \"idvs:\ngdp_ue\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"8\" [label = \"idvs:\nfull\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"9\" [label = \"treat_extreme_obs\", shape = \"rectangle\", fixedsize = \"FALSE\", fillcolor = \"#7EC0EE\", fontcolor = \"#FFFFFF\"] \n  \"10\" [label = \"outlier_tment_style:\nwin\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"11\" [label = \"outlier_tment_style:\ntrunc\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"12\" [label = \"outlier_cutoff\nvalid_min: 0\nvalid_max: 0.1\", shape = \"oval\", fixedsize = \"FALSE\", fillcolor = \"#4A708B\", fontcolor = \"#FFFFFF\"] \n  \"13\" [label = \"specify_model\", shape = \"rectangle\", fixedsize = \"FALSE\", fillcolor = \"#7EC0EE\", fontcolor = \"#FFFFFF\"] \n  \"14\" [label = \"model_type:\nlevel-level\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"15\" [label = \"model_type:\nlog-level\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"16\" [label = \"model_type:\nlevel-log\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"17\" [label = \"model_type:\nlog-log\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"18\" [label = \"est_model\", shape = \"rectangle\", fixedsize = \"FALSE\", fillcolor = \"#7EC0EE\", fontcolor = \"#FFFFFF\"] \n  \"19\" [label = \"feffect:\nnone\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"20\" [label = \"feffect:\ncountry\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"21\" [label = \"feffect:\nyear\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"22\" [label = \"feffect:\nctryyear\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"23\" [label = \"cluster:\nnone\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"24\" [label = \"cluster:\ncountry\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"25\" [label = \"cluster:\nyear\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"26\" [label = \"cluster:\nctryyear\", shape = \"ellipse\", fixedsize = \"FALSE\", fillcolor = \"#6CA6CD\", fontcolor = \"#FFFFFF\"] \n  \"27\" [label = \"result\", shape = \"diamond\", fixedsize = \"FALSE\", fillcolor = \"#708090\", fontcolor = \"#FFFFFF\"] \n  \"1\"->\"2\" \n  \"1\"->\"3\" \n  \"2\"->\"4\" \n  \"3\"->\"4\" \n  \"4\"->\"5\" \n  \"4\"->\"6\" \n  \"4\"->\"7\" \n  \"4\"->\"8\" \n  \"5\"->\"9\" \n  \"6\"->\"9\" \n  \"7\"->\"9\" \n  \"8\"->\"9\" \n  \"9\"->\"10\" \n  \"9\"->\"11\" \n  \"10\"->\"12\" \n  \"11\"->\"12\" \n  \"12\"->\"13\" \n  \"13\"->\"14\" \n  \"13\"->\"15\" \n  \"13\"->\"16\" \n  \"13\"->\"17\" \n  \"14\"->\"18\" \n  \"15\"->\"18\" \n  \"16\"->\"18\" \n  \"17\"->\"18\" \n  \"18\"->\"19\" \n  \"18\"->\"20\" \n  \"18\"->\"21\" \n  \"18\"->\"22\" \n  \"19\"->\"23\" \n  \"19\"->\"24\" \n  \"19\"->\"25\" \n  \"19\"->\"26\" \n  \"20\"->\"23\" \n  \"20\"->\"24\" \n  \"20\"->\"25\" \n  \"20\"->\"26\" \n  \"21\"->\"23\" \n  \"21\"->\"24\" \n  \"21\"->\"25\" \n  \"21\"->\"26\" \n  \"22\"->\"23\" \n  \"22\"->\"24\" \n  \"22\"->\"25\" \n  \"22\"->\"26\" \n  \"23\"->\"27\" \n  \"24\"->\"27\" \n  \"25\"->\"27\" \n  \"26\"->\"27\" \n}","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="step-4-optional-but-encouraged-simulate-data-for-additional-testing-and-power-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#step-4-optional-but-encouraged-simulate-data-for-additional-testing-and-power-analysis" class="anchor"></a>Step 4 (optional but encouraged): Simulate data for additional testing and power analysis</h2>
<p>While not strictly necessary, a very useful next step is to simulate your raw data. Simulating your data early in the project can be very helpful for various reasons:</p>
<ul>
<li>It allows you to test your design steps without requiring you to work with your real data, which would strictly speaking constitute a breach of the “don’t mix exploration with inference” rule.</li>
<li>You can simulate your expected effect and verify that your design identifies it correctly.</li>
<li>You can assess the power of your design.</li>
</ul>
<p>To demonstrate these steps, I use a very quick’n’dirty simulation approach. It creates a country year panel and simulates data that are roughly comparable to real data. It uses the following level-log setup:</p>
<p><span class="math inline">\(lifeexpectancy = \beta_0 + \frac{es}{\log(1.1)}\log(gdp\_capita) + 10\log(mn\_yrs\_school) + 5log(unemployment) + \epsilon\)</span></p>
<p>with <span class="math inline">\(\beta_0\)</span> being based on country-level base-lines that are adjusted for sample means of the independent variables. The effect <code>es</code> of a 10 % increase of <code><a href="https://www.rdocumentation.org/packages/base/topics/Log">log(gdp_capita)</a></code> on <code>lifeexpectancy</code> in years is our main variable of interest. Like the <code>read_data()</code> function, <code>sim_data()</code> returns a path to a temporary CSV file containing the simulated data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sim_data &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">countries =</span> <span class="dv">75</span>, <span class="dt">es =</span> <span class="dv">1</span>, <span class="dt">years =</span> <span class="dv">15</span>) {
  n &lt;-<span class="st"> </span>countries <span class="op">*</span><span class="st"> </span>years
  df &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/expand.grid">expand.grid</a></span>(<span class="dt">country =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(<span class="dv">1</span><span class="op">:</span>countries), 
                    <span class="dt">year =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.ordered</a></span>((<span class="dv">2016</span> <span class="op">-</span><span class="st"> </span>years <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)<span class="op">:</span><span class="dv">2016</span>))

  mm_gdp_capita &lt;-<span class="st"> </span><span class="dv">18000</span>
  sd_gdp_capita &lt;-<span class="st"> </span><span class="dv">20000</span>
  location &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(mm_gdp_capita<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(sd_gdp_capita<span class="op">^</span><span class="dv">2</span> <span class="op">+</span><span class="st"> </span>mm_gdp_capita<span class="op">^</span><span class="dv">2</span>))
  shape &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">sqrt</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span>(sd_gdp_capita<span class="op">^</span><span class="dv">2</span> <span class="op">/</span><span class="st"> </span>mm_gdp_capita<span class="op">^</span><span class="dv">2</span>)))

  base_gdp_capita &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Lognormal">rlnorm</a></span>(countries, location, shape)
  base_unemp &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Beta">rbeta</a></span>(countries, <span class="dv">2</span>, <span class="dv">20</span>)<span class="op">*</span><span class="dv">100</span>
  base_mn_yrs_school &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">pmax</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">pmin</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(countries, <span class="dv">4</span>, <span class="dv">2</span>), <span class="dv">13</span>), <span class="dv">1</span>)
  base_le &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(countries, <span class="dv">70</span>, <span class="dv">10</span>)
  base_le[base_le <span class="op">&gt;</span><span class="st"> </span><span class="dv">70</span>] &lt;-<span class="st"> </span><span class="dv">70</span> <span class="op">+</span><span class="st"> </span><span class="fl">0.6</span> <span class="op">*</span><span class="st"> </span>(base_le[base_le <span class="op">&gt;</span><span class="st"> </span><span class="dv">70</span>] <span class="op">-</span><span class="st"> </span><span class="dv">70</span>)

  <span class="cf">for</span> (yr <span class="cf">in</span> (<span class="dv">2016</span> <span class="op">-</span><span class="st"> </span>years <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)<span class="op">:</span><span class="dv">2016</span>) {
    <span class="cf">if</span> (yr <span class="op">==</span><span class="st"> </span><span class="dv">2016</span> <span class="op">-</span><span class="st"> </span>years <span class="op">+</span><span class="st"> </span><span class="dv">1</span>) df<span class="op">$</span>gdp_capita[df<span class="op">$</span>year <span class="op">==</span><span class="st"> </span>yr] &lt;-<span class="st"> </span>base_gdp_capita
    <span class="cf">else</span> df<span class="op">$</span>gdp_capita[df<span class="op">$</span>year <span class="op">==</span><span class="st"> </span>yr] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">pmax</a></span>(df<span class="op">$</span>gdp_capita[df<span class="op">$</span>year <span class="op">==</span><span class="st"> </span>yr <span class="op">-</span><span class="st"> </span><span class="dv">1</span>] <span class="op">+</span>
<span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(countries, <span class="dv">0</span>, <span class="fl">0.01</span> <span class="op">*</span><span class="st"> </span>sd_gdp_capita), <span class="dv">100</span>) <span class="op">*</span>
<span class="st">        </span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(countries, <span class="fl">0.02</span>, <span class="fl">0.02</span>))
  }
  df<span class="op">$</span>mn_yrs_school &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">pmax</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(base_mn_yrs_school, years) <span class="op">+</span>
<span class="st">                              </span><span class="fl">0.1</span> <span class="op">*</span><span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(df<span class="op">$</span>gdp_capita) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(df<span class="op">$</span>gdp_capita))) <span class="op">+</span>
<span class="st">                              </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n, <span class="fl">0.5</span>, <span class="fl">0.3</span>), <span class="dv">1</span>)
  df<span class="op">$</span>unemployment &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">pmax</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(base_unemp, years) <span class="op">-</span><span class="st"> </span>
<span class="st">                            </span><span class="fl">0.2</span> <span class="op">*</span><span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(df<span class="op">$</span>gdp_capita) <span class="op">-</span><span class="st"> </span>
<span class="st">                                     </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(df<span class="op">$</span>gdp_capita))) <span class="op">+</span><span class="st"> </span>
<span class="st">                            </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n, <span class="fl">0.2</span>, <span class="fl">0.2</span>), <span class="fl">0.0001</span>)
  df<span class="op">$</span>lifeexpectancy &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(base_le, years) <span class="op">-</span><span class="st"> </span>
<span class="st">    </span><span class="dv">10</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(df<span class="op">$</span>mn_yrs_school)) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="dv">5</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(df<span class="op">$</span>unemployment)) <span class="op">-</span>
<span class="st">    </span>(es<span class="op">/</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(<span class="fl">1.1</span>)) <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(df<span class="op">$</span>gdp_capita)) <span class="op">+</span>
<span class="st">    </span><span class="dv">10</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(df<span class="op">$</span>mn_yrs_school) <span class="op">-</span><span class="st">  </span>
<span class="st">    </span><span class="dv">5</span> <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(df<span class="op">$</span>unemployment) <span class="op">+</span>
<span class="st">    </span>(es<span class="op">/</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(<span class="fl">1.1</span>)) <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(df<span class="op">$</span>gdp_capita) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">rnorm</a></span>(n, <span class="dv">0</span>, <span class="dv">5</span>)

  df<span class="op">$</span>lifeexpectancy &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">pmax</a></span>(df<span class="op">$</span>lifeexpectancy, <span class="dv">30</span>)
  df &lt;-<span class="st"> </span>df[, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"country"</span>, <span class="st">"year"</span>, <span class="st">"lifeexpectancy"</span>, 
               <span class="st">"gdp_capita"</span>, <span class="st">"mn_yrs_school"</span>, <span class="st">"unemployment"</span>)]
  tfile &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/tempfile">tempfile</a></span>(<span class="st">"simdata"</span>, <span class="dt">fileext =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">".csv"</span>))
  <span class="kw"><a href="https://readr.tidyverse.org/reference/write_delim.html">write_csv</a></span>(df, tfile)
  tfile
}</code></pre></div>
<p>Using this code we can now test whether our design steps are able to process the data. This tests whether based on our simulated data each step is able to run with each feasible choice, producing output and creating no warnings or errors.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/test_design.html">test_design</a></span>(design, <span class="dt">input =</span> <span class="kw">sim_data</span>(), <span class="dt">reporter =</span> <span class="st">"minimal"</span>)
<span class="co">#&gt; ...............................................................................................................................................................................................................................................................................................</span></code></pre></div>
<p>This looks good. Now let’s see whether the design generates an effect estimate that is consistent with the effect of 1 year that we simulated. For that, we pick the protocol that is consistent with the simulation, meaning that</p>
<ul>
<li>We use the full model since <code>sim_data()</code> incorporated effects of <code>unemployment</code> and <code>mn_yrs_school</code>,</li>
<li>we do not treat outliers,</li>
<li>we use the level-log model specification,</li>
<li>and we include country and year fixed effects and also cluster our standard errors by country and year.</li>
</ul>
<p>We use the function <code><a href="../reference/simulate_design_power.html">simulate_design_power()</a></code> for this step. This function runs a provided protocol on simulated data, with specified sample and effect size. The sample size is given in cross-sectional units here. The function returns a data frame containing the results for each simulation run. The density of the point estimates allows us to assess the consistency of our design.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">power_df &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/simulate_design_power.html">simulate_design_power</a></span>(design, 
                        <span class="dt">protocol =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">na_omit =</span> <span class="st">"no"</span>, 
                                        <span class="dt">idvs =</span> <span class="st">"full"</span>,
                                        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
                                          <span class="dt">outlier_tment_style =</span> <span class="st">"win"</span>,
                                          <span class="dt">outlier_cutoff =</span> <span class="dv">0</span>
                                        ),
                                        <span class="dt">model_type =</span> <span class="st">"level-log"</span>,
                                        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
                                          <span class="dt">fecffect =</span> <span class="st">"ctryyear"</span>,
                                          <span class="dt">cluster =</span> <span class="st">"ctryyear"</span>
                                        )), 
                        <span class="dt">input_sim_func =</span> sim_data, 
                        <span class="dt">range_n =</span> <span class="dv">150</span>,
                        <span class="dt">effect_size =</span> <span class="dv">1</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(power_df, <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> est)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_density">geom_density</a></span>(<span class="dt">color =</span> <span class="ot">NA</span>, <span class="dt">fill =</span> <span class="st">"lightblue"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_minimal</a></span>()</code></pre></div>
<p><img src="analyzing_rdf_files/figure-html/check_design_consist-1.png" width="700" style="display: block; margin: auto;"></p>
<p>This looks OK. Now: How about the power? We continue to assume that a 10% increase in GDP per capita increases life expectancy by a year. How likely is that we will be able observe this effect in the data? Let’s see whether we have enough power to detect such an effect.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">power_df &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/simulate_design_power.html">simulate_design_power</a></span>(design, 
                        <span class="dt">protocol =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">na_omit =</span> <span class="st">"no"</span>, 
                                        <span class="dt">idvs =</span> <span class="st">"full"</span>,
                                        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
                                          <span class="dt">outlier_tment_style =</span> <span class="st">"win"</span>,
                                          <span class="dt">outlier_cutoff =</span> <span class="dv">0</span>
                                        ),
                                        <span class="dt">model_type =</span> <span class="st">"level-log"</span>,
                                        <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(
                                          <span class="dt">fecffect =</span> <span class="st">"ctryyear"</span>,
                                          <span class="dt">cluster =</span> <span class="st">"ctryyear"</span>
                                        )), 
                        <span class="dt">input_sim_func =</span> sim_data, 
                        <span class="dt">range_n =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">10</span>, <span class="dv">100</span>, <span class="dv">10</span>),
                        <span class="dt">effect_size =</span> <span class="dv">1</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(power_df, <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> n, <span class="dt">y =</span> est)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="dt">color =</span> <span class="st">"lightblue"</span>, <span class="dt">position =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/position_dodge">position_dodge</a></span>(<span class="dt">width =</span> <span class="fl">0.5</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_minimal</a></span>()</code></pre></div>
<p><img src="analyzing_rdf_files/figure-html/check_power-1.png" width="700" style="display: block; margin: auto;"></p>
<p>As <code>n</code>, the number of cross-sectional units (countries) in our simulation, increases, the distribution of our point estimates for our simulated effect narrows and centers on the simulated effect size of one year. This is good. What is the number of countries that are needed, assuming 15 observations per country, to reach a power of <span class="math inline">\(0.8\)</span>?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">power_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/na.fail">na.omit</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(n) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="dt">power =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(lb <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)<span class="op">/</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/n.html">n</a></span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> n, <span class="dt">y =</span> power)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>(<span class="dt">color =</span> <span class="st">"lightblue"</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_minimal</a></span>()</code></pre></div>
<p><img src="analyzing_rdf_files/figure-html/power_graph-1.png" width="700" style="display: block; margin: auto;"></p>
<p>Roughly 40 countries, yielding 600 observations. The world bank data will have more observations than that. So, power will not be an issue in our analysis, at least not if the effect size is comparable to the one we assumed.</p>
<p>We have now verified that our design is capable to identify a simulated effect without bias and with sufficient power. Time to run it on real data.</p>
</div>
<div id="step-5-estimate-effect" class="section level2">
<h2 class="hasAnchor">
<a href="#step-5-estimate-effect" class="anchor"></a>Step 5: Estimate effect</h2>
<p>As we provided weights for each design step choice, we can now estimate the effect by applying these weights on our design. This is done by first running <code><a href="../reference/exhaust_design.html">exhaust_design(..., weight = TRUE)</a></code> on the actual data and by then using the returned protocol estimates from this function call as input to <code><a href="../reference/calculate_weighted_estimate.html">calculate_weighted_estimate()</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">weighted_ests &lt;-<span class="st"> </span><span class="kw"><a href="../reference/exhaust_design.html">exhaust_design</a></span>(design, <span class="st">"https://joachim-gassen.github.io/data/wb_new.csv"</span>,
                                <span class="dt">weight =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">weighted_eff &lt;-<span class="st"> </span><span class="kw"><a href="../reference/calculate_weighted_estimate.html">calculate_weighted_estimate</a></span>(weighted_ests, <span class="st">"est"</span>, <span class="st">"lb"</span>, <span class="st">"ub"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(weighted_eff), <span class="dt">digits =</span> <span class="dv">3</span>)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">est</th>
<th align="right">lb</th>
<th align="right">ub</th>
<th align="right">n</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">0.112</td>
<td align="right">0.031</td>
<td align="right">0.193</td>
<td align="right">12</td>
</tr></tbody>
</table>
<p>The estimated weighted effect size of 0.112 is much smaller than our simulated effect of one year. We can also assess the results for each of the twelve protocols with non-zero weights.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/knitr/topics/kable">kable</a></span>(weighted_ests, <span class="dt">digits =</span> <span class="dv">3</span>)</code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">na.omit</th>
<th align="left">idvs</th>
<th align="left">outlier_tment_style</th>
<th align="right">outlier_cutoff</th>
<th align="left">model_type</th>
<th align="left">feffect</th>
<th align="left">cluster</th>
<th align="right">weight</th>
<th align="right">est</th>
<th align="right">lb</th>
<th align="right">ub</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">yes</td>
<td align="left">full</td>
<td align="left">win</td>
<td align="right">0.00</td>
<td align="left">level-log</td>
<td align="left">ctryyear</td>
<td align="left">ctryyear</td>
<td align="right">0.05</td>
<td align="right">0.136</td>
<td align="right">0.046</td>
<td align="right">0.225</td>
</tr>
<tr class="even">
<td align="left">yes</td>
<td align="left">full</td>
<td align="left">trunc</td>
<td align="right">0.00</td>
<td align="left">level-log</td>
<td align="left">ctryyear</td>
<td align="left">ctryyear</td>
<td align="right">0.05</td>
<td align="right">0.136</td>
<td align="right">0.046</td>
<td align="right">0.225</td>
</tr>
<tr class="odd">
<td align="left">yes</td>
<td align="left">full</td>
<td align="left">win</td>
<td align="right">0.01</td>
<td align="left">level-log</td>
<td align="left">ctryyear</td>
<td align="left">ctryyear</td>
<td align="right">0.10</td>
<td align="right">0.118</td>
<td align="right">0.041</td>
<td align="right">0.196</td>
</tr>
<tr class="even">
<td align="left">yes</td>
<td align="left">full</td>
<td align="left">trunc</td>
<td align="right">0.01</td>
<td align="left">level-log</td>
<td align="left">ctryyear</td>
<td align="left">ctryyear</td>
<td align="right">0.10</td>
<td align="right">0.104</td>
<td align="right">0.036</td>
<td align="right">0.173</td>
</tr>
<tr class="odd">
<td align="left">yes</td>
<td align="left">full</td>
<td align="left">win</td>
<td align="right">0.05</td>
<td align="left">level-log</td>
<td align="left">ctryyear</td>
<td align="left">ctryyear</td>
<td align="right">0.10</td>
<td align="right">0.095</td>
<td align="right">0.024</td>
<td align="right">0.167</td>
</tr>
<tr class="even">
<td align="left">yes</td>
<td align="left">full</td>
<td align="left">trunc</td>
<td align="right">0.05</td>
<td align="left">level-log</td>
<td align="left">ctryyear</td>
<td align="left">ctryyear</td>
<td align="right">0.10</td>
<td align="right">0.079</td>
<td align="right">0.006</td>
<td align="right">0.152</td>
</tr>
<tr class="odd">
<td align="left">yes</td>
<td align="left">full</td>
<td align="left">win</td>
<td align="right">0.00</td>
<td align="left">log-log</td>
<td align="left">ctryyear</td>
<td align="left">ctryyear</td>
<td align="right">0.05</td>
<td align="right">0.164</td>
<td align="right">0.053</td>
<td align="right">0.274</td>
</tr>
<tr class="even">
<td align="left">yes</td>
<td align="left">full</td>
<td align="left">trunc</td>
<td align="right">0.00</td>
<td align="left">log-log</td>
<td align="left">ctryyear</td>
<td align="left">ctryyear</td>
<td align="right">0.05</td>
<td align="right">0.164</td>
<td align="right">0.053</td>
<td align="right">0.274</td>
</tr>
<tr class="odd">
<td align="left">yes</td>
<td align="left">full</td>
<td align="left">win</td>
<td align="right">0.01</td>
<td align="left">log-log</td>
<td align="left">ctryyear</td>
<td align="left">ctryyear</td>
<td align="right">0.10</td>
<td align="right">0.135</td>
<td align="right">0.047</td>
<td align="right">0.223</td>
</tr>
<tr class="even">
<td align="left">yes</td>
<td align="left">full</td>
<td align="left">trunc</td>
<td align="right">0.01</td>
<td align="left">log-log</td>
<td align="left">ctryyear</td>
<td align="left">ctryyear</td>
<td align="right">0.10</td>
<td align="right">0.116</td>
<td align="right">0.043</td>
<td align="right">0.190</td>
</tr>
<tr class="odd">
<td align="left">yes</td>
<td align="left">full</td>
<td align="left">win</td>
<td align="right">0.05</td>
<td align="left">log-log</td>
<td align="left">ctryyear</td>
<td align="left">ctryyear</td>
<td align="right">0.10</td>
<td align="right">0.093</td>
<td align="right">0.013</td>
<td align="right">0.174</td>
</tr>
<tr class="even">
<td align="left">yes</td>
<td align="left">full</td>
<td align="left">trunc</td>
<td align="right">0.05</td>
<td align="left">log-log</td>
<td align="left">ctryyear</td>
<td align="left">ctryyear</td>
<td align="right">0.10</td>
<td align="right">0.083</td>
<td align="right">0.007</td>
<td align="right">0.160</td>
</tr>
</tbody>
</table>
<p>The protocol estimates are significant at the conventional 95 % level for all twelve protocols. You can also run a single protocol to analyze its full model results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res &lt;-
<span class="st">  </span><span class="kw">read_data</span>(<span class="st">"https://joachim-gassen.github.io/data/wb_new.csv"</span>, <span class="st">"yes"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select_idvs</span>(<span class="st">"full"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">treat_extreme_obs</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"win"</span>, <span class="fl">0.01</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">specify_model</span>(<span class="st">"level-log"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">est_model</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"ctryyear"</span>, <span class="st">"ctryyear"</span>))

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(res<span class="op">$</span>model)
<span class="co">#&gt; </span>
<span class="co">#&gt; Call:</span>
<span class="co">#&gt;    lfe::felm(formula = form, data = input$data) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residuals:</span>
<span class="co">#&gt;     Min      1Q  Median      3Q     Max </span>
<span class="co">#&gt; -7.3006 -0.6092  0.0612  0.6129 10.8838 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Coefficients:</span>
<span class="co">#&gt;               Estimate Cluster s.e. t value Pr(&gt;|t|)    </span>
<span class="co">#&gt; gdp_capita      1.2410       0.4155   2.987  0.00284 ** </span>
<span class="co">#&gt; mn_yrs_school   7.4985       1.3322   5.629 1.95e-08 ***</span>
<span class="co">#&gt; unemployment   -0.1483       0.3467  -0.428  0.66884    </span>
<span class="co">#&gt; ---</span>
<span class="co">#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Residual standard error: 1.567 on 3798 degrees of freedom</span>
<span class="co">#&gt; Multiple R-squared(full model): 0.9751   Adjusted R-squared: 0.9738 </span>
<span class="co">#&gt; Multiple R-squared(proj model): 0.128   Adjusted R-squared: 0.08228 </span>
<span class="co">#&gt; F-statistic(full model, *iid*):748.9 on 199 and 3798 DF, p-value: &lt; 2.2e-16 </span>
<span class="co">#&gt; F-statistic(proj model): 13.76 on 3 and 172 DF, p-value: 4.396e-08</span></code></pre></div>
<p>Note that, while the implemented design returns an estimate of the life expectancy effect in years of a 10 % increase in GDP per capita, the documented model estimates of a level-log specification have to be transformed to produce that estimate. Based on the selected model, a 10 % increase in GDP per capita would be associated with <span class="math inline">\(1.241 \log(1.1) \approx 0.118\)</span> years change in life expectancy. Overall, one can conclude that the additional explanatory power of our independent variables in explaining life expectancy is modest once one allows for country and year fixed effects. Consistent with <a href="https://doi.org/10.1111/padr.12141">Lutz and Kebede (2018)</a>, we find a pronounced and significant association of schooling with life expectancy, but due to potential reverse causality issues I would be hesitant to argue causality here.</p>
<p>How robust is our weighted effect estimate across our documented researcher degrees of freedom? Time to exhaust our design across all available design choices.</p>
</div>
<div id="step-6-assess-robustness-of-effect" class="section level2">
<h2 class="hasAnchor">
<a href="#step-6-assess-robustness-of-effect" class="anchor"></a>Step 6: Assess robustness of effect</h2>
<p>We will now exhaust all design choices and estimate our effect for each feasible protocol. As these combine to 11,264 protocols, running the code below will take a while. This is why we load the data that is generated by the commented lines from the disk.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># ests &lt;- exhaust_design(design,</span>
<span class="co">#                        "https://joachim-gassen.github.io/data/wb_new.csv")</span>
<span class="co"># save(ests, file = "case_study_ests.RData")</span>

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/load">load</a></span>(<span class="st">"case_study_ests.RData"</span>)</code></pre></div>
<p>Let’s see how the estimates distribute across our researcher degrees of freedom.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_rdf_estimate_density.html">plot_rdf_estimate_density</a></span>(ests, <span class="st">"est"</span>, <span class="st">"lb"</span>, <span class="st">"ub"</span>, <span class="dt">color =</span> <span class="st">"lightblue"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_minimal</a></span>()</code></pre></div>
<p><img src="analyzing_rdf_files/figure-html/estimate_density-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Quite a range of estimates. How do the coefficients vary by model specification?<br>
For a quick overview the package has implemented the specification curve visual as suggested by <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2694998">Simonsohn, Simmons and Nelson</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_rdf_spec_curve.html">plot_rdf_spec_curve</a></span>(ests, <span class="st">"est"</span>, <span class="st">"lb"</span>, <span class="st">"ub"</span>, <span class="dt">sample_frac =</span> <span class="fl">0.1</span>) </code></pre></div>
<p><img src="analyzing_rdf_files/figure-html/spec_curve-1.png" width="672" style="display: block; margin: auto;"></p>
<p>This visual is based on a 10 % sample of estimates (can be adjusted via the <code>sample_frac</code> parameter). It provides a very good first impression of both, the overall distribution of the main estimate of interest as well as influential choices.</p>
<p>For example, you see that the type of the estimation model is influential for the magnitude of the effect. To be able to assess the precise range of our estimates conditional on this discrete choice, we now use the <code>plot_rdf_by_dchoice()</code> function with histogram-based ridge lines instead of densities.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/plot_rdf_ridges_by_dchoice.html">plot_rdf_ridges_by_dchoice</a></span>(ests, <span class="st">"est"</span>, <span class="st">"model_type"</span>, <span class="dt">hist =</span> <span class="ot">TRUE</span>, <span class="dt">scale =</span> <span class="fl">0.9</span>, <span class="dt">fill =</span> <span class="st">"lightblue"</span>, <span class="dt">color =</span> <span class="ot">NA</span>)</code></pre></div>
<p><img src="analyzing_rdf_files/figure-html/estimate_density_by_model_type-1.png" width="672" style="display: block; margin: auto;"></p>
<p>In line with the overall shape of the Preston curve, the specifications with untransformed (level) independent variables generate estimates closer to zero than the ones with log-transformed independent variables. For the following, we will concentrate on the specifications with log-transformed independent variables that we hypothesized.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">log_ests &lt;-<span class="st"> </span>ests <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(model_type <span class="op">==</span><span class="st"> "level-log"</span> <span class="op">|</span><span class="st"> </span>model_type <span class="op">==</span><span class="st"> "log-log"</span>)

<span class="kw"><a href="../reference/plot_rdf_ridges_by_dchoice.html">plot_rdf_ridges_by_dchoice</a></span>(log_ests, <span class="st">"est"</span>, <span class="st">"feffect"</span>, <span class="dt">hist =</span> <span class="ot">TRUE</span>, <span class="dt">scale =</span> <span class="fl">0.9</span>, <span class="dt">fill =</span> <span class="st">"lightblue"</span>, <span class="dt">color =</span> <span class="ot">NA</span>)</code></pre></div>
<p><img src="analyzing_rdf_files/figure-html/estimate_density_by_feffect-1.png" width="672" style="display: block; margin: auto;"></p>
<p>The influence of the applied fixed effect structure on the coefficient of interest is striking. A set of country and year fixed effects controls for unobserved time-invariant cross-sectional heterogeneity and for unobserved cross-sectionally-invariant time trends. The former can be explained by, e.g., regional determinants like climate influencing life expectancy and the latter by developments in medical services and other social aspects that materialize across time and are constant across countries. As both are likely to be influential on theoretical grounds, we limit the analysis now on protocols that employ country and firm fixed effects and that use log-transformed independent variables. Also, we limit the analysis to models that estimate confidence intervals based on two-way clustered standard errors.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rel_ests &lt;-<span class="st"> </span>log_ests <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(feffect <span class="op">==</span><span class="st"> "ctryyear"</span> <span class="op">&amp;</span><span class="st"> </span>
<span class="st">           </span>cluster <span class="op">==</span><span class="st"> "ctryyear"</span>)

<span class="kw"><a href="../reference/plot_rdf_ridges_by_dchoice.html">plot_rdf_ridges_by_dchoice</a></span>(rel_ests, <span class="st">"est"</span>, <span class="st">"idvs"</span>, <span class="dt">hist =</span> <span class="ot">TRUE</span>, <span class="dt">scale =</span> <span class="fl">0.9</span>, <span class="dt">fill =</span> <span class="st">"lightblue"</span>, <span class="dt">color =</span> <span class="ot">NA</span>)</code></pre></div>
<p><img src="analyzing_rdf_files/figure-html/estimate_density_by_idvs-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Hmm… While most of the protocols generate an estimate roughly in the range of 0.05 to 0.15 years, some of the univariate estimates are smaller and even below zero. Let’s focus on them for a second and see whether they are driven by sample selection.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rel_ests <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(idvs <span class="op">==</span><span class="st"> "gdp_only"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/plot_rdf_ridges_by_dchoice.html">plot_rdf_ridges_by_dchoice</a></span>(<span class="st">"est"</span>, <span class="st">"na.omit"</span>, <span class="dt">hist =</span> <span class="ot">TRUE</span>, <span class="dt">scale =</span> <span class="fl">0.9</span>, <span class="dt">fill =</span> <span class="st">"lightblue"</span>, <span class="dt">color =</span> <span class="ot">NA</span>)</code></pre></div>
<p><img src="analyzing_rdf_files/figure-html/estimate_density_by_idvs_na-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Yes, this seems to be the case. When assessed univariately on the largest possible sample, the range of estimates becomes considerably larger. Is this driven by extreme observations?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rel_ests <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(idvs <span class="op">==</span><span class="st"> "gdp_only"</span>,
         na.omit <span class="op">==</span><span class="st"> "no"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/plot_rdf_estimates_by_choice.html">plot_rdf_estimates_by_choice</a></span>(<span class="st">"est"</span>, <span class="st">"lb"</span>, <span class="st">"ub"</span>, <span class="st">"outlier_tment_style"</span>, 
                               <span class="dt">color =</span> <span class="st">"model_type"</span>, <span class="dt">order =</span> <span class="st">"outlier_cutoff"</span>, <span class="dt">width =</span> <span class="fl">0.008</span>)</code></pre></div>
<p><img src="analyzing_rdf_files/figure-html/estimates_gdp_only_by_outlier-1.png" width="672" style="display: block; margin: auto;"></p>
<p>This seems to be the case. In general, the stricter the outlier treatment, the larger the estimate. In addition, the univariate level-log specifications are generating larger and slightly narrower estimates compared to the univariate log-log specification, consistent with a percentage increase in GDP rather being associated with an absolute increase in life expectancy than a relative one. This seems reasonable because of diminishing rates of returns to wealth.</p>
<p>Our last test will focus on the multivariate analyses that just use schooling as additional control, since including unemployment reduces the sample size while contributing little to the explanatory power of the model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rel_ests <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(na.omit <span class="op">==</span><span class="st"> "no"</span>,
         idvs <span class="op">==</span><span class="st"> "gdp_school"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="../reference/plot_rdf_estimates_by_choice.html">plot_rdf_estimates_by_choice</a></span>(<span class="st">"est"</span>, <span class="st">"lb"</span>, <span class="st">"ub"</span>, <span class="st">"outlier_tment_style"</span>, 
                               <span class="dt">color =</span> <span class="st">"model_type"</span>, <span class="dt">order =</span> <span class="st">"outlier_cutoff"</span>, <span class="dt">width =</span> <span class="fl">0.008</span>)</code></pre></div>
<p><img src="analyzing_rdf_files/figure-html/estimates_gdp_school_by_outlier-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Again, outliers turn out to be influential here but into the opposite direction. Focusing on the narrower estimates of the level-log specification, it becomes apparent that removing outliers by truncating renders the estimate smaller and insignificant, while winsorizing extreme values does little to the coefficient.</p>
</div>
<div id="summing-up" class="section level2">
<h2 class="hasAnchor">
<a href="#summing-up" class="anchor"></a>Summing up</h2>
<p>Using the <code>rdfanalysis</code> package, we are able to systematically explore the 11,264 degrees of freedom that we identified in a supposedly straight-forward panel data analysis of observational data.</p>
<p>Allowing for time-invariant country-level unobservables and country-invariant unobservables affecting the time-series and controlling for unemployment and years of schooling, we estimate the effect of a 10 % increase of GDP per capita on life expectancy to be in the area of 0.03 to 0.19 years. Assuming that no other unobservables or reverse causality issues affect our findings, this coefficient could be interpreted as causal, but given how courageous these assumptions are I strongly advise against it.</p>
<p>As can be assessed by the researcher degrees of freedom exploration, our estimate is only one of many feasible estimates. The total range of estimates spans from a lower bound of -0.35 to an upper bound of 0.92 years. Three observations stand out from the exploration:</p>
<ul>
<li>The country-year fixed effect structure has a large dampening effect on the estimates.</li>
<li>Using log-transformed values for the independent variables generally increases the estimates.</li>
<li>The implicit sample selection caused by including additional control variables is also influential for our estimate and tends to increase it.</li>
</ul>
<p>It is impressive to see the number of researcher degrees of freedom that even such a simple research design like the one at hand implies. My hope is that the <code>rdfanalysis</code> package might motivate researchers to think more deeply about their choice set and to explore and document their findings more transparently.</p>
<p>If you have remarks about this vignette or the package, I would love to hear from you. Feel free to reach out via <a href="mailto:gassen@wiwi.hu-berlin.de">email</a> or <a href="https://twitter.com/JoachimGassen">twitter</a>.</p>
<p>Enjoy!</p>
</div>
<div id="appendix" class="section level2">
<h2 class="hasAnchor">
<a href="#appendix" class="anchor"></a>Appendix</h2>
<p>Below you find the code to run the data in the ExPanD shiny web app for extensive interactive exploration. You can re-generate most protocols from above and more. An online version is accessible <a href="https://jgassen.shinyapps.io/expand_rdfanalysis">here</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ExPanDaR)

df_all &lt;-<span class="st"> </span><span class="kw"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span>(<span class="st">"https://joachim-gassen.github.io/data/wb_new.csv"</span>, <span class="dt">col_types =</span> <span class="kw"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span>()) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"country"</span>, <span class="st">"year"</span>), as.factor) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"lifeexpectancy"</span>, <span class="st">"gdp_capita"</span>,
           <span class="st">"mn_yrs_school"</span>, <span class="st">"unemployment"</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">ln =</span> log)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(country, region, year, 
         gdp_capita, lifeexpectancy,
         mn_yrs_school, unemployment,
         gdp_capita_ln, lifeexpectancy_ln, 
         mn_yrs_school_ln, unemployment_ln) 

df_na.omit &lt;-<span class="st"> </span>df_all <span class="op">%&gt;%</span><span class="st"> </span>na.omit

wb_var_def &lt;-<span class="st"> </span>worldbank_var_def <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">4</span>,<span class="dv">8</span>,<span class="dv">23</span>,<span class="dv">19</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(worldbank_data_def, <span class="dt">by =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"var_def"</span> =<span class="st"> "var_name"</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>var_def) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="dt">var_def =</span> var_def.y,
         <span class="dt">type =</span> type.x) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(var_name, var_def, type, can_be_na) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/reexports.html">add_row</a></span>(<span class="dt">var_name =</span> <span class="st">"mn_yrs_school"</span>, <span class="dt">var_def =</span> <span class="st">"Mean number of years spent in school, age group 15+. Source: Wittgenstein Centre for Demography and Global Human Capital (2018). Wittgenstein Centre Data Explorer Version 2.0. Data between five year intervals are based on linear interpolation."</span>, 
          <span class="dt">type =</span> <span class="st">"numeric"</span>, <span class="dt">can_be_na =</span> <span class="dv">1</span>, <span class="dt">.after =</span> <span class="dv">5</span>)

<span class="cf">for</span> (var <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"gdp_capita"</span>, <span class="st">"lifeexpectancy"</span>, <span class="st">"mn_yrs_school"</span>, <span class="st">"unemployment"</span>)) {
  wb_var_def &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(wb_var_def,
                      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(var, <span class="st">"_ln"</span>), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"Log-transformed version of"</span>, var), <span class="st">"numeric"</span>, <span class="dv">1</span>))
}

abstract &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">"&lt;p&gt;&amp;nbsp;&lt;/p&gt;&lt;p&gt;This interactive display is part of the "</span>,
                  <span class="st">"&lt;a href=https://joachim-gassen.github.io/rdfanalysis&gt;"</span>,
                  <span class="st">"R package rdfanalysis&lt;/a&gt;."</span>,
                  <span class="st">"The package provides researchers with a coding framework"</span>,
                  <span class="st">"that supports formal documentation and systematic"</span>,
                  <span class="st">"exploration of the researcher degrees of freedom that are"</span>,
                  <span class="st">"inherent in research designs.&lt;/p&gt;"</span>,
                  <span class="st">"&lt;p&gt;Data is provided by the World Bank and the Wittgenstein"</span>,
                  <span class="st">"Centre and used to assess the impact of real"</span>,
                  <span class="st">"gross domestic product (GDP) per capita on life expectancy."</span>,
                  <span class="st">"This association has become known as the Preston Curve.&lt;p&gt;"</span>,
                  <span class="st">"You can choose below whether you want to examine a sample"</span>,
                  <span class="st">"with or without missing observations. Hover over the"</span>,
                  <span class="st">"variable names in the descriptive table to see variable"</span>,
                  <span class="st">"definitions and use the various displays to explore the"</span>, 
                  <span class="st">"data.&lt;p&gt;"</span>,
                  <span class="st">"Joachim Gassen - &lt;a href=mailto:gassen@wiwi.hu-berlin.de&gt;"</span>,
                  <span class="st">"gassen@wiwi.hu-berlin.de&lt;/a&gt; - March 2019"</span>)


<span class="kw"><a href="https://www.rdocumentation.org/packages/ExPanDaR/topics/ExPanD">ExPanD</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(df_all, df_na.omit), 
       <span class="dt">df_name =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"All observations"</span>, <span class="st">"Observations with NAs omitted"</span>),
       <span class="dt">df_def =</span> wb_var_def,
       <span class="dt">title =</span> <span class="st">"Explore the Link Between National Income and Life Expectancy (Preston Curve)"</span>,
       <span class="dt">abstract =</span> abstract)</code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#the-case">The Case</a></li>
      <li><a href="#step-1-define-research-design-by-a-series-of-functions">Step 1: Define research design by a series of functions</a></li>
      <li><a href="#step-2-implement-design-steps">Step 2: Implement design steps</a></li>
      <li><a href="#step-3-source-test-and-document-design">Step 3: Source, test and document design</a></li>
      <li><a href="#step-4-optional-but-encouraged-simulate-data-for-additional-testing-and-power-analysis">Step 4 (optional but encouraged): Simulate data for additional testing and power analysis</a></li>
      <li><a href="#step-5-estimate-effect">Step 5: Estimate effect</a></li>
      <li><a href="#step-6-assess-robustness-of-effect">Step 6: Assess robustness of effect</a></li>
      <li><a href="#summing-up">Summing up</a></li>
      <li><a href="#appendix">Appendix</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Joachim Gassen.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
